# T√†i li·ªáu Ki·∫øn tr√∫c Fullstack: ChatStoryAI

## 1. Gi·ªõi thi·ªáu

T√†i li·ªáu n√†y ph√°c th·∫£o ki·∫øn tr√∫c k·ªπ thu·∫≠t to√†n di·ªán cho ·ª©ng d·ª•ng **ChatStoryAI**. M·ª•c ƒë√≠ch c·ªßa t√†i li·ªáu n√†y l√† cung c·∫•p m·ªôt c√°i nh√¨n t·ªïng quan, th·ªëng nh·∫•t v·ªÅ t·∫•t c·∫£ c√°c th√†nh ph·∫ßn h·ªá th·ªëng, t·ª´ frontend, backend, c∆° s·ªü d·ªØ li·ªáu, ƒë·∫øn c√°c d·ªãch v·ª• b√™n ngo√†i v√† quy tr√¨nh tri·ªÉn khai. T√†i li·ªáu n√†y ƒë√≥ng vai tr√≤ l√† ngu·ªìn tham kh·∫£o ch√≠nh cho ƒë·ªôi ng≈© ph√°t tri·ªÉn, ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n, kh·∫£ nƒÉng b·∫£o tr√¨ v√† m·ªü r·ªông c·ªßa d·ª± √°n.

ƒê√¢y l√† b·∫£n ph√¢n t√≠ch ki·∫øn tr√∫c c·ªßa m·ªôt d·ª± √°n hi·ªán c√≥ (brownfield analysis) nh·∫±m ghi l·∫°i c·∫•u tr√∫c hi·ªán t·∫°i v√† ƒë∆∞a ra c√°c ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn.

### 1.1. B·ªëi c·∫£nh d·ª± √°n

ChatStoryAI l√† m·ªôt n·ªÅn t·∫£ng s√°ng t·∫°o truy·ªán v·ªõi s·ª± h·ªó tr·ª£ c·ªßa AI, ƒë∆∞·ª£c ph√°t tri·ªÉn b·ªüi nh√≥m sinh vi√™n DA22TTC - Tr∆∞·ªùng ƒê·∫°i h·ªçc Tr√† Vinh. N·ªÅn t·∫£ng cho ph√©p ng∆∞·ªùi d√πng t·∫°o v√† chia s·∫ª nh·ªØng c√¢u chuy·ªán ƒë·ªôc ƒë√°o v·ªõi s·ª± h·ªó tr·ª£ c·ªßa c√°c m√¥ h√¨nh ng√¥n ng·ªØ l·ªõn (AI) nh∆∞ Google Gemini v√† Together AI.

H·ªá th·ªëng cung c·∫•p c√°c t√≠nh nƒÉng ch√≠nh:

- **S√°ng t·∫°o v·ªõi AI**: T·∫°o √Ω t∆∞·ªüng truy·ªán, ph√°t tri·ªÉn nh√¢n v·∫≠t, t·∫°o h·ªôi tho·∫°i, qu·∫£n l√Ω ch∆∞∆°ng v√† ƒë·∫°i c∆∞∆°ng
- **Th∆∞ vi·ªán truy·ªán**: ƒê·ªçc truy·ªán ƒëa d·∫°ng th·ªÉ lo·∫°i v·ªõi t√≠nh nƒÉng theo d√µi ti·∫øn ƒë·ªô
- **Qu·∫£n l√Ω n·ªôi dung**: T·∫°o v√† qu·∫£n l√Ω truy·ªán, nh√¢n v·∫≠t, ch∆∞∆°ng v√† c·ªët truy·ªán
- **T√≠ch h·ª£p thanh to√°n**: H·ªó tr·ª£ g√≥i premium v·ªõi VNPay
- **API m·ªü**: Cung c·∫•p API key cho c√°c ·ª©ng d·ª•ng b√™n ngo√†i

### 1.2. Nh·∫≠t k√Ω thay ƒë·ªïi

| Ng√†y       | Phi√™n b·∫£n | M√¥ t·∫£                                                    | T√°c gi·∫£             |
| :--------- | :-------- | :------------------------------------------------------- | :------------------ |
| 25/06/2024 | 1.0       | Ph√¢n t√≠ch v√† t·∫°o t√†i li·ªáu ki·∫øn tr√∫c ban ƒë·∫ßu t·ª´ m√£ ngu·ªìn. | Winston (Architect) |
| 17/07/2025 | 2.0       | C·∫≠p nh·∫≠t ph√¢n t√≠ch to√†n di·ªán d·ª± √°n v√† c·∫•u tr√∫c hi·ªán t·∫°i. | Winston (Architect) |

## 2. Ki·∫øn tr√∫c t·ªïng quan

### 2.1. T√≥m t·∫Øt k·ªπ thu·∫≠t

ChatStoryAI ƒë∆∞·ª£c x√¢y d·ª±ng theo ki·∫øn tr√∫c **monorepo full-stack** s·ª≠ d·ª•ng **Next.js** v·ªõi App Router. Ki·∫øn tr√∫c n√†y t√≠ch h·ª£p ch·∫∑t ch·∫Ω c·∫£ frontend v√† backend trong c√πng m·ªôt codebase, gi√∫p ƒë∆°n gi·∫£n h√≥a vi·ªác ph√°t tri·ªÉn v√† tri·ªÉn khai. H·ªá th·ªëng s·ª≠ d·ª•ng **MySQL** l√†m c∆° s·ªü d·ªØ li·ªáu quan h·ªá, **Google Drive** ƒë·ªÉ l∆∞u tr·ªØ file, v√† t√≠ch h·ª£p v·ªõi c√°c d·ªãch v·ª• AI c·ªßa **Google Gemini** v√† **Together AI** ƒë·ªÉ h·ªó tr·ª£ s√°ng t·∫°o n·ªôi dung. X√°c th·ª±c ng∆∞·ªùi d√πng ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi **NextAuth.js**.

### 2.2. N·ªÅn t·∫£ng v√† H·∫° t·∫ßng

- **M√¥i tr∆∞·ªùng Local:** S·ª≠ d·ª•ng **Docker** v√† **Docker Compose** ƒë·ªÉ thi·∫øt l·∫≠p m·ªôt m√¥i tr∆∞·ªùng ph√°t tri·ªÉn nh·∫•t qu√°n, bao g·ªìm d·ªãch v·ª• ·ª©ng d·ª•ng Next.js v√† c∆° s·ªü d·ªØ li·ªáu MySQL.
- **H·∫° t·∫ßng tri·ªÉn khai (D·ª± ki·∫øn):** D·ª±a tr√™n c·∫•u h√¨nh `next.config.ts` (`output: 'standalone'`) v√† c√°c quy tr√¨nh trong `.github/workflows`, n·ªÅn t·∫£ng tri·ªÉn khai ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t l√† **Vercel** ho·∫∑c m·ªôt n·ªÅn t·∫£ng Node.js t∆∞∆°ng t·ª±. Vercel cung c·∫•p kh·∫£ nƒÉng t√≠ch h·ª£p li·ªÅn m·∫°ch v·ªõi Next.js, CI/CD t·ª± ƒë·ªông v√† CDN to√†n c·∫ßu.
- **L∆∞u tr·ªØ File:** **Google Drive API** ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ l∆∞u tr·ªØ ·∫£nh ƒë·∫°i di·ªán v√† ·∫£nh b√¨a truy·ªán.
- **C∆° s·ªü d·ªØ li·ªáu:** **MySQL 8.0** ƒë∆∞·ª£c container h√≥a, ƒë·∫£m b·∫£o t√≠nh di ƒë·ªông gi·ªØa c√°c m√¥i tr∆∞·ªùng.

### 2.3. S∆° ƒë·ªì ki·∫øn tr√∫c t·ªïng quan

ƒê√¢y l√† s∆° ƒë·ªì tr·ª±c quan h√≥a c√°c th√†nh ph·∫ßn ch√≠nh v√† lu·ªìng t∆∞∆°ng t√°c trong h·ªá th·ªëng ChatStoryAI.

```mermaid
graph TD
    subgraph "Ng∆∞·ªùi d√πng"
        User["<i class='fa fa-user'></i> Ng∆∞·ªùi d√πng"]
    end

    subgraph "H·∫° t·∫ßng Cloud (Vercel/T∆∞∆°ng t·ª±)"
        subgraph "·ª®ng d·ª•ng Next.js (Monorepo)"
            Frontend["üåê Giao di·ªán ng∆∞·ªùi d√πng<br>(Next.js - React Components)"]
            Backend["‚öôÔ∏è API Routes<br>(Next.js Backend)"]
        end
    end

    subgraph "D·ªãch v·ª• Backend & L∆∞u tr·ªØ"
        DB[(üóÉÔ∏è MySQL Database)]
        GDRIVE["<i class='fab fa-google-drive'></i> Google Drive<br>(L∆∞u tr·ªØ ·∫£nh)"]
    end

    subgraph "D·ªãch v·ª• b√™n ngo√†i (APIs)"
        GEMINI["ü§ñ Google Gemini API<br>(T·∫°o sinh n·ªôi dung)"]
        TOGETHER["üé® Together AI API<br>(T·∫°o sinh h√¨nh ·∫£nh)"]
        VNPAY["üí≥ VNPay API<br>(Thanh to√°n)"]
        GMAIL["üìß Gmail API<br>(G·ª≠i email)"]
    end

    User -->|T∆∞∆°ng t√°c qua tr√¨nh duy·ªát| Frontend
    Frontend -->|G·ªçi API n·ªôi b·ªô| Backend
    Backend -->|Truy v·∫•n d·ªØ li·ªáu| DB
    Backend -->|L∆∞u/T·∫£i file| GDRIVE
    Backend -->|Y√™u c·∫ßu AI| GEMINI
    Backend -->|Y√™u c·∫ßu AI| TOGETHER
    Backend -->|T·∫°o thanh to√°n| VNPAY
    Backend -->|G·ª≠i email x√°c th·ª±c| GMAIL
```

### 2.4. C√°c m·∫´u ki·∫øn tr√∫c v√† thi·∫øt k·∫ø

- **Monorepo Full-stack:** To√†n b·ªô m√£ ngu·ªìn frontend v√† backend ƒë∆∞·ª£c qu·∫£n l√Ω trong c√πng m·ªôt repository, gi√∫p ƒë∆°n gi·∫£n h√≥a vi·ªác chia s·∫ª code (v√≠ d·ª•: c√°c `types`) v√† quy tr√¨nh build.
- **Server Components & Client Components (Next.js App Router):** T·∫≠n d·ª•ng ki·∫øn tr√∫c m·ªõi c·ªßa Next.js ƒë·ªÉ t·ªëi ∆∞u h√≥a hi·ªáu nƒÉng, gi·∫£m l∆∞·ª£ng JavaScript g·ª≠i v·ªÅ client.
- **API Routes:** Backend ƒë∆∞·ª£c x√¢y d·ª±ng d∆∞·ªõi d·∫°ng c√°c API Route b√™n trong Next.js, cho ph√©p t·∫°o c√°c endpoint RESTful m·ªôt c√°ch nhanh ch√≥ng.
- **Service Layer:** Logic nghi·ªáp v·ª• ƒë∆∞·ª£c t√°ch ra kh·ªèi c√°c API handler v√† ƒë·∫∑t trong `src/services` (v√≠ d·ª•: `AuthService`, `ApiKeyService`), gi√∫p m√£ ngu·ªìn d·ªÖ ƒë·ªçc, d·ªÖ b·∫£o tr√¨ v√† ki·ªÉm th·ª≠.
- **Repository Pattern (Implicit):** Vi·ªác s·ª≠ d·ª•ng `pool` t·ª´ `src/lib/db.ts` trong c√°c services ƒë·ªÉ t∆∞∆°ng t√°c v·ªõi CSDL l√† m·ªôt d·∫°ng ƒë∆°n gi·∫£n c·ªßa m·∫´u Repository, tr·ª´u t∆∞·ª£ng h√≥a vi·ªác truy c·∫≠p d·ªØ li·ªáu.
- **Dual Authentication:** H·ªó tr·ª£ c·∫£ **Session-based** (cho ng∆∞·ªùi d√πng web) v√† **API Key-based** (cho c√°c ·ª©ng d·ª•ng b√™n ngo√†i), mang l·∫°i s·ª± linh ho·∫°t cao.

## 3. NgƒÉn x·∫øp c√¥ng ngh·ªá (Tech Stack)

### 3.1. C√¥ng ngh·ªá ch√≠nh

| H·∫°ng m·ª•c         | C√¥ng ngh·ªá    | Phi√™n b·∫£n (t·ª´ package.json) | M·ª•c ƒë√≠ch                                               |
| :--------------- | :----------- | :-------------------------- | :----------------------------------------------------- |
| **Framework**    | Next.js      | ^15.3.3                     | X√¢y d·ª±ng ·ª©ng d·ª•ng full-stack, SSR, API routes.         |
| **Ng√¥n ng·ªØ**     | TypeScript   | ^5                          | ƒê·∫£m b·∫£o an to√†n ki·ªÉu d·ªØ li·ªáu v√† tƒÉng kh·∫£ nƒÉng b·∫£o tr√¨. |
| **Giao di·ªán**    | React        | ^19.0.0                     | Th∆∞ vi·ªán UI ch√≠nh.                                     |
| **Styling**      | Tailwind CSS | ^3.4.1                      | Framework CSS Utility-first.                           |
| **Component UI** | shadcn/ui    | ^0.9.4                      | B·ªô component UI c√≥ kh·∫£ nƒÉng t√πy bi·∫øn cao.              |
| **Database**     | MySQL        | 8.0 (Docker)                | L∆∞u tr·ªØ d·ªØ li·ªáu quan h·ªá c·ªßa ·ª©ng d·ª•ng.                  |
| **X√°c th·ª±c**     | NextAuth.js  | ^4.24.11                    | Qu·∫£n l√Ω phi√™n ƒëƒÉng nh·∫≠p v√† OAuth (Google).             |
| **Container**    | Docker       | 3.8 (Compose)               | ƒê√≥ng g√≥i v√† ch·∫°y ·ª©ng d·ª•ng, CSDL.                       |

### 3.2. D·ªãch v·ª• b√™n ngo√†i v√† API

| H·∫°ng m·ª•c          | C√¥ng ngh·ªá        | Phi√™n b·∫£n             | M·ª•c ƒë√≠ch                                 |
| :---------------- | :--------------- | :-------------------- | :--------------------------------------- |
| **L∆∞u tr·ªØ file**  | Google Drive API | ^144.0.0 (googleapis) | L∆∞u tr·ªØ ·∫£nh b√¨a v√† avatar ng∆∞·ªùi d√πng.    |
| **AI - VƒÉn b·∫£n**  | Google Gemini    | ^0.22.0               | T·∫°o √Ω t∆∞·ªüng, h·ªôi tho·∫°i, n·ªôi dung truy·ªán. |
| **AI - H√¨nh ·∫£nh** | Together AI      | ^0.13.0               | T·∫°o ·∫£nh b√¨a v√† avatar.                   |
| **Thanh to√°n**    | VNPay            | ^1.6.1                | T√≠ch h·ª£p c·ªïng thanh to√°n VNPay.          |
| **Email**         | Nodemailer       | ^6.10.0               | G·ª≠i email (v√≠ d·ª•: ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u).     |
| **Email Client**  | EmailJS          | ^4.4.1                | G·ª≠i email t·ª´ client-side.                |

### 3.3. Th∆∞ vi·ªán h·ªó tr·ª£

| H·∫°ng m·ª•c          | C√¥ng ngh·ªá              | Phi√™n b·∫£n | M·ª•c ƒë√≠ch                     |
| :---------------- | :--------------------- | :-------- | :--------------------------- |
| **T√†i li·ªáu API**  | Swagger (JSDoc)        | ^6.2.8    | T·ª± ƒë·ªông t·∫°o t√†i li·ªáu API.    |
| **Markdown**      | React Markdown         | ^10.0.0   | Render markdown content.     |
| **Animation**     | Framer Motion          | ^12.4.7   | Animations v√† transitions.   |
| **Animation**     | GSAP                   | ^3.12.7   | Advanced animations.         |
| **Icons**         | Lucide React           | ^0.475.0  | Icon library.                |
| **Icons**         | React Icons            | ^5.5.0    | Additional icon sets.        |
| **Date**          | date-fns               | ^4.1.0    | Date manipulation utilities. |
| **Notifications** | Sonner                 | ^2.0.1    | Toast notifications.         |
| **Loading**       | React Loading Skeleton | ^3.5.0    | Loading skeletons.           |
| **Security**      | bcryptjs               | ^3.0.2    | Password hashing.            |

## 4. M√¥ h√¨nh d·ªØ li·ªáu v√† Schema

### 4.1. T·ªïng quan Database

C∆° s·ªü d·ªØ li·ªáu MySQL 8.0 ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ l∆∞u tr·ªØ to√†n b·ªô th√¥ng tin c·ªßa ·ª©ng d·ª•ng v·ªõi charset `utf8mb4` ƒë·ªÉ h·ªó tr·ª£ ƒë·∫ßy ƒë·ªß Unicode. Database ƒë∆∞·ª£c kh·ªüi t·∫°o th√¥ng qua Docker v·ªõi c√°c file migration trong `docker/mysql/init/`.

### 4.2. C√°c b·∫£ng ch√≠nh

#### 4.2.1. Qu·∫£n l√Ω ng∆∞·ªùi d√πng v√† x√°c th·ª±c

- **`users`**: L∆∞u th√¥ng tin ng∆∞·ªùi d√πng (user_id, username, email, user_password, avatar, drive_file_id, has_badge)
- **`api_keys`**: Qu·∫£n l√Ω API keys cho truy c·∫≠p b√™n ngo√†i v·ªõi permissions JSON v√† th·ªùi gian h·∫øt h·∫°n
- **`reset_codes`**: M√£ x√°c th·ª±c ƒë·∫∑t l·∫°i m·∫≠t kh·∫©u v·ªõi th·ªùi gian h·∫øt h·∫°n

#### 4.2.2. Qu·∫£n l√Ω truy·ªán v√† n·ªôi dung

- **`stories`**: B·∫£ng trung t√¢m l∆∞u th√¥ng tin truy·ªán (story_id, user_id, title, description, cover_image, status, view_count)
- **`story_chapters`**: C√°c ch∆∞∆°ng c·ªßa truy·ªán v·ªõi `order_number` v√† `publish_order` ri√™ng bi·ªát
- **`story_characters`**: Th√¥ng tin chi ti·∫øt nh√¢n v·∫≠t (name, avatar_image, description, role, gender, personality, appearance, background)
- **`story_outlines`**: ƒê·∫°i c∆∞∆°ng v√† d√†n √Ω cho truy·ªán
- **`chapter_dialogues`**: H·ªôi tho·∫°i v√† m√¥ t·∫£ trong ch∆∞∆°ng, li√™n k·∫øt v·ªõi nh√¢n v·∫≠t
- **`main_categories`, `story_tags`, `story_tag_relations`**: H·ªá th·ªëng ph√¢n lo·∫°i v√† g·∫Øn th·∫ª

#### 4.2.3. T∆∞∆°ng t√°c ng∆∞·ªùi d√πng

- **`story_bookmarks`**: ƒê√°nh d·∫•u truy·ªán y√™u th√≠ch
- **`story_favorites`**: Truy·ªán ƒë∆∞·ª£c y√™u th√≠ch
- **`view_history`**: L·ªãch s·ª≠ xem truy·ªán
- **`chapter_reads`**: Theo d√µi ch∆∞∆°ng ƒë√£ ƒë·ªçc

#### 4.2.4. AI v√† Chat

- **`ai_chat_history`**: L·ªãch s·ª≠ phi√™n chat v·ªõi AI
- **`ai_chat_messages`**: Tin nh·∫Øn trong phi√™n chat (role: user/assistant, command_status)
- **`ai_chat_images`**: H√¨nh ·∫£nh ƒë∆∞·ª£c t·∫°o trong chat
- **`ai_generated_dialogues`**: H·ªôi tho·∫°i ƒë∆∞·ª£c AI t·∫°o ra

### 4.3. ƒê√°nh gi√° thi·∫øt k·∫ø Database

**ƒêi·ªÉm m·∫°nh:**

- Thi·∫øt k·∫ø chu·∫©n v·ªõi kh√≥a ngo·∫°i ƒë·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu
- `ON DELETE CASCADE` ƒë∆∞·ª£c s·ª≠ d·ª•ng h·ª£p l√Ω ƒë·ªÉ d·ªçn d·∫πp d·ªØ li·ªáu li√™n quan
- T√°ch `order_number` v√† `publish_order` trong `story_chapters` cho ph√©p qu·∫£n l√Ω th·ª© t·ª± vi·∫øt v√† xu·∫•t b·∫£n ƒë·ªôc l·∫≠p
- H·ªó tr·ª£ JSON trong `api_keys.permissions` cho flexibility
- Index ƒë∆∞·ª£c thi·∫øt l·∫≠p h·ª£p l√Ω cho performance

**C·∫ßn c·∫£i thi·ªán:**

- Thi·∫øu b·∫£ng `notifications` m·∫∑c d√π c√≥ API endpoint
- Ch∆∞a c√≥ b·∫£ng `story_outlines` trong schema hi·ªán t·∫°i
- C√≥ th·ªÉ c·∫ßn th√™m soft delete cho m·ªôt s·ªë b·∫£ng quan tr·ªçng

## 5. Ki·∫øn tr√∫c Backend (API Routes)

### 5.1. T·ªïng quan API Architecture

Backend ƒë∆∞·ª£c x√¢y d·ª±ng ho√†n to√†n b·∫±ng API Routes c·ªßa Next.js, ƒë·∫∑t t·∫°i `src/app/api` v·ªõi c·∫•u tr√∫c resource-based routing r·∫•t logic v√† c√≥ t·ªï ch·ª©c.

### 5.2. C·∫•u tr√∫c API Endpoints

#### 5.2.1. Authentication & User Management

```
/api/auth/
‚îú‚îÄ‚îÄ [...nextauth]/          # NextAuth.js endpoints
‚îú‚îÄ‚îÄ login/                  # Custom login
‚îú‚îÄ‚îÄ register/               # User registration
‚îú‚îÄ‚îÄ forgot-password/        # Password reset request
‚îú‚îÄ‚îÄ verify-reset-code/      # Verify reset code
‚îî‚îÄ‚îÄ reset-password/         # Reset password

/api/user/
‚îú‚îÄ‚îÄ api-keys/              # API key management
‚îú‚îÄ‚îÄ update-avatar/         # Update user avatar
‚îú‚îÄ‚îÄ update-username/       # Update username
‚îú‚îÄ‚îÄ update-password/       # Change password
‚îú‚îÄ‚îÄ update-badge/          # Update badge status
‚îî‚îÄ‚îÄ delete-account/        # Account deletion
```

#### 5.2.2. Story Management

```
/api/stories/
‚îú‚îÄ‚îÄ route.ts               # List stories
‚îú‚îÄ‚îÄ create/                # Create new story
‚îú‚îÄ‚îÄ featured/              # Featured stories
‚îî‚îÄ‚îÄ [id]/
    ‚îú‚îÄ‚îÄ route.ts           # Get/Update/Delete story
    ‚îú‚îÄ‚îÄ chapters/          # Chapter management
    ‚îú‚îÄ‚îÄ characters/        # Character management
    ‚îú‚îÄ‚îÄ outlines/          # Story outlines
    ‚îî‚îÄ‚îÄ dialogues/         # Chapter dialogues
```

#### 5.2.3. Library & Content Discovery

```
/api/library/
‚îú‚îÄ‚îÄ [id]/                  # Get story details
‚îú‚îÄ‚îÄ new/                   # New stories
‚îú‚îÄ‚îÄ popular/               # Popular stories
‚îî‚îÄ‚îÄ search/                # Search functionality

/api/categories/           # Story categories
```

#### 5.2.4. AI Integration

```
/api/ai/
‚îú‚îÄ‚îÄ gemini/                # Google Gemini integration
‚îî‚îÄ‚îÄ chat-history/          # AI chat history

/api/together/
‚îî‚îÄ‚îÄ key/                   # Together AI key management
```

#### 5.2.5. Other Services

```
/api/account/
‚îú‚îÄ‚îÄ bookmarks/             # User bookmarks
‚îî‚îÄ‚îÄ view-history/          # Reading history

/api/notifications/        # Notification system
/api/vnpay/               # Payment integration
/api/subscribe/           # Newsletter subscription
/api/docs/                # API documentation
/api/revalidate/          # Cache revalidation
```

### 5.3. Ki·∫øn tr√∫c v√† Patterns

- **Resource-based Routing:** API ƒë∆∞·ª£c t·ªï ch·ª©c theo t√†i nguy√™n, d·ªÖ hi·ªÉu v√† maintain
- **Dual Authentication:** H·ªó tr·ª£ c·∫£ session-based (NextAuth) v√† API key-based authentication
- **Service Layer Pattern:** Logic nghi·ªáp v·ª• ƒë∆∞·ª£c t√°ch ra kh·ªèi route handlers v√†o `src/services/`
- **Database Connection Pooling:** S·ª≠ d·ª•ng connection pool t·ª´ `src/lib/db.ts` cho hi·ªáu su·∫•t t·ªëi ∆∞u
- **Structured Error Handling:** S·ª≠ d·ª•ng try-catch v·ªõi JSON response c√≥ c·∫•u tr√∫c nh·∫•t qu√°n

## 6. Ki·∫øn tr√∫c Frontend

### 6.1. T·ªïng quan Frontend Architecture

Frontend ƒë∆∞·ª£c x√¢y d·ª±ng b·∫±ng React 19 v√† Next.js 15 App Router, s·ª≠ d·ª•ng TypeScript ƒë·ªÉ ƒë·∫£m b·∫£o type safety v√† Tailwind CSS cho styling.

### 6.2. C·∫•u tr√∫c th∆∞ m·ª•c v√† Components

#### 6.2.1. App Router Structure

```
src/app/
‚îú‚îÄ‚îÄ (pages)/
‚îÇ   ‚îú‚îÄ‚îÄ about/             # Trang gi·ªõi thi·ªáu
‚îÇ   ‚îú‚îÄ‚îÄ account/           # T√†i kho·∫£n ng∆∞·ªùi d√πng
‚îÇ   ‚îú‚îÄ‚îÄ ai/                # AI Assistant
‚îÇ   ‚îú‚îÄ‚îÄ contact/           # Li√™n h·ªá
‚îÇ   ‚îú‚îÄ‚îÄ docs/              # API Documentation
‚îÇ   ‚îú‚îÄ‚îÄ guide/             # H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng
‚îÇ   ‚îú‚îÄ‚îÄ library/           # Th∆∞ vi·ªán truy·ªán
‚îÇ   ‚îú‚îÄ‚îÄ payment/           # Thanh to√°n
‚îÇ   ‚îú‚îÄ‚îÄ products/          # S·∫£n ph·∫©m
‚îÇ   ‚îú‚îÄ‚îÄ services/          # D·ªãch v·ª•
‚îÇ   ‚îú‚îÄ‚îÄ settings/          # C√†i ƒë·∫∑t
‚îÇ   ‚îî‚îÄ‚îÄ stories/           # Qu·∫£n l√Ω truy·ªán
‚îú‚îÄ‚îÄ api/                   # API Routes
‚îú‚îÄ‚îÄ globals.css            # Global styles
‚îú‚îÄ‚îÄ layout.tsx             # Root layout
‚îî‚îÄ‚îÄ page.tsx               # Homepage
```

#### 6.2.2. Component Architecture

```
src/components/
‚îú‚îÄ‚îÄ ui/                    # Primitive components (shadcn/ui)
‚îÇ   ‚îú‚îÄ‚îÄ button.tsx
‚îÇ   ‚îú‚îÄ‚îÄ card.tsx
‚îÇ   ‚îú‚îÄ‚îÄ input.tsx
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ ai-generator/          # AI-specific components
‚îú‚îÄ‚îÄ api-keys/              # API key management
‚îú‚îÄ‚îÄ login/                 # Authentication components
‚îú‚îÄ‚îÄ nav/                   # Navigation components
‚îú‚îÄ‚îÄ story/                 # Story-related components
‚îú‚îÄ‚îÄ chat-bot.tsx           # AI Chat interface
‚îú‚îÄ‚îÄ story-card.tsx         # Story display card
‚îú‚îÄ‚îÄ notification-bell.tsx  # Notifications
‚îî‚îÄ‚îÄ user-avatar.tsx        # User avatar display
```

### 6.3. State Management v√† Data Flow

- **Local State:** Ch·ªß y·∫øu s·ª≠ d·ª•ng React hooks (`useState`, `useEffect`, `useReducer`)
- **Context API:** S·ª≠ d·ª•ng cho shared state nh∆∞ `LoadingProvider`, `SessionProvider`
- **Data Fetching:** Native `fetch` API v·ªõi custom hooks nh∆∞ `use-debounce.ts`
- **Form Handling:** Controlled components v·ªõi validation logic
- **Loading States:** Custom `LoadingProvider` ƒë·ªÉ qu·∫£n l√Ω loading states to√†n c·ª•c

### 6.4. UI/UX v√† Styling

- **Design System:** shadcn/ui components v·ªõi Tailwind CSS
- **Responsive Design:** Mobile-first approach v·ªõi Tailwind breakpoints
- **Animations:** Framer Motion cho complex animations, GSAP cho advanced effects
- **Icons:** Lucide React v√† React Icons
- **Typography:** Tailwind Typography plugin cho markdown content
- **Dark Mode:** H·ªó tr·ª£ theme switching (n·∫øu c√≥)

### 6.5. Performance Optimizations

- **Server Components:** S·ª≠ d·ª•ng Next.js Server Components khi c√≥ th·ªÉ
- **Code Splitting:** Automatic v·ªõi Next.js App Router
- **Image Optimization:** Next.js Image component v·ªõi Google Drive integration
- **Loading Skeletons:** React Loading Skeleton cho better UX
- **Debouncing:** Custom hook cho search v√† input optimization

## 7. DevOps v√† Deployment

### 7.1. Containerization v·ªõi Docker

D·ª± √°n s·ª≠ d·ª•ng Docker ƒë·ªÉ ƒë·∫£m b·∫£o t√≠nh nh·∫•t qu√°n gi·ªØa c√°c m√¥i tr∆∞·ªùng:

```yaml
# docker-compose.yml
services:
  mysql:
    image: mysql:8.0
    environment:
      MYSQL_DATABASE: chatstoryai
      MYSQL_USER: chatstory_user
    volumes:
      - mysql_data:/var/lib/mysql
      - ./docker/mysql/init:/docker-entrypoint-initdb.d

  app:
    build: .
    ports:
      - "3000:3000"
    depends_on:
      mysql:
        condition: service_healthy
```

**Dockerfile** s·ª≠ d·ª•ng multi-stage build v·ªõi Node.js 20 Alpine ƒë·ªÉ t·ªëi ∆∞u k√≠ch th∆∞·ªõc image.

### 7.2. CI/CD Pipeline v·ªõi GitHub Actions

D·ª± √°n c√≥ h·ªá th·ªëng CI/CD to√†n di·ªán v·ªõi c√°c workflow:

#### 7.2.1. Continuous Integration (`ci.yml`)

- **Code Quality:** ESLint, TypeScript checking
- **Build Verification:** Next.js build test
- **Security Scanning:** Dependency vulnerability check
- **Automated Testing:** Unit tests (n·∫øu c√≥)

#### 7.2.2. Performance Monitoring (`performance.yml`)

- **Lighthouse Audits:** T·ª± ƒë·ªông ƒë√°nh gi√° performance, accessibility, SEO
- **Performance Budgets:** Theo d√µi metrics v√† c·∫£nh b√°o regression
- **Core Web Vitals:** Monitoring LCP, FID, CLS

#### 7.2.3. Security Pipeline (`security.yml`)

- **Dependency Scanning:** Automated vulnerability detection
- **Secret Detection:** Prevent credential leaks
- **SAST:** Static Application Security Testing
- **License Compliance:** Open source license checking

#### 7.2.4. Deployment (`deploy.yml`)

- **Automated Deployment:** Deploy to production on main branch
- **Environment Management:** Staging v√† production environments
- **Rollback Capability:** Quick rollback on deployment failures
- **Health Checks:** Post-deployment verification

### 7.3. Environment Configuration

```bash
# Environment Variables
MYSQL_HOST=localhost
MYSQL_PORT=3307
MYSQL_DATABASE=chatstoryai
NEXTAUTH_SECRET=***
GOOGLE_CLIENT_ID=***
GOOGLE_CLIENT_SECRET=***
GEMINI_API_KEY=***
TOGETHER_API_KEY=***
VNP_TMN_CODE=***
VNP_HASH_SECRET=***
```

### 7.4. Deployment Strategy

- **Platform:** Vercel (recommended) ho·∫∑c Docker-based deployment
- **Database:** MySQL 8.0 v·ªõi connection pooling
- **File Storage:** Google Drive API integration
- **CDN:** Next.js automatic optimization + Vercel Edge Network
- **Monitoring:** Built-in analytics v·ªõi Vercel Analytics v√† Speed Insights

## 8. ƒê√°nh gi√° v√† ƒê·ªÅ xu·∫•t Ki·∫øn tr√∫c

### 8.1. ƒêi·ªÉm m·∫°nh c·ªßa ki·∫øn tr√∫c hi·ªán t·∫°i

**Ki·∫øn tr√∫c t·ªïng th·ªÉ:**

- **Monorepo Full-stack:** ƒê∆°n gi·∫£n h√≥a development v√† deployment
- **Modern Tech Stack:** Next.js 15, React 19, TypeScript - c√¥ng ngh·ªá hi·ªán ƒë·∫°i v√† ·ªïn ƒë·ªãnh
- **Containerization:** Docker setup ho√†n ch·ªânh cho development v√† production
- **CI/CD Pipeline:** GitHub Actions workflow to√†n di·ªán

**Backend Architecture:**

- **Resource-based API:** C·∫•u tr√∫c API logic v√† d·ªÖ maintain
- **Dual Authentication:** H·ªó tr·ª£ c·∫£ session v√† API key authentication
- **Service Layer:** T√°ch bi·ªát logic nghi·ªáp v·ª• kh·ªèi API handlers
- **Database Design:** Schema ƒë∆∞·ª£c thi·∫øt k·∫ø t·ªët v·ªõi foreign keys v√† indexes

**Frontend Architecture:**

- **Component Organization:** C·∫•u tr√∫c component r√µ r√†ng v·ªõi shadcn/ui
- **Performance:** Server Components v√† automatic code splitting
- **Developer Experience:** TypeScript, ESLint, hot reload

### 8.2. C√°c v·∫•n ƒë·ªÅ c·∫ßn c·∫£i thi·ªán

#### 8.2.1. L∆∞u tr·ªØ File (∆Øu ti√™n cao)

**V·∫•n ƒë·ªÅ hi·ªán t·∫°i:**

- Google Drive API kh√¥ng ph·∫£i gi·∫£i ph√°p t·ªëi ∆∞u cho static assets
- C√≥ th·ªÉ g·∫∑p rate limiting v√† performance issues
- Qu·∫£n l√Ω permissions ph·ª©c t·∫°p

**ƒê·ªÅ xu·∫•t:**

- Chuy·ªÉn sang **Vercel Blob**, **AWS S3**, ho·∫∑c **Cloudflare R2**
- Implement CDN cho faster content delivery
- S·ª≠ d·ª•ng signed URLs cho secure access

#### 8.2.2. Testing Strategy (∆Øu ti√™n cao)

**V·∫•n ƒë·ªÅ hi·ªán t·∫°i:**

- Thi·∫øu automated testing suite
- R·ªßi ro regression bugs cao
- Kh√≥ maintain code quality khi scale

**ƒê·ªÅ xu·∫•t:**

```typescript
// Implement testing stack
- Unit Tests: Vitest + React Testing Library
- Integration Tests: API route testing
- E2E Tests: Playwright ho·∫∑c Cypress
- Test Coverage: Minimum 80% coverage target
```

#### 8.2.3. State Management (∆Øu ti√™n trung b√¨nh)

**V·∫•n ƒë·ªÅ hi·ªán t·∫°i:**

- Ch·ªâ s·ª≠ d·ª•ng local state v√† Context API
- Kh√≥ share state gi·ªØa distant components
- Prop drilling trong m·ªôt s·ªë tr∆∞·ªùng h·ª£p

**ƒê·ªÅ xu·∫•t:**

- Implement **Zustand** ho·∫∑c **Jotai** cho global state
- Maintain React Query/SWR cho server state
- Keep local state cho UI-specific data

#### 8.2.4. Error Handling (∆Øu ti√™n trung b√¨nh)

**V·∫•n ƒë·ªÅ hi·ªán t·∫°i:**

- Error handling kh√¥ng consistent
- Thi·∫øu centralized error logging
- User experience khi c√≥ l·ªói ch∆∞a t·ªëi ∆∞u

**ƒê·ªÅ xu·∫•t:**

```typescript
// Centralized error handler
export class ApiError extends Error {
  constructor(
    public statusCode: number,
    message: string,
    public code?: string
  ) {
    super(message);
  }
}

// Error boundary cho React components
// Structured error responses cho API
```

### 8.3. ƒê·ªÅ xu·∫•t c·∫£i ti·∫øn d√†i h·∫°n

#### 8.3.1. Monitoring v√† Observability

- Implement **Sentry** cho error tracking
- Add **Prometheus** metrics cho performance monitoring
- Setup **Grafana** dashboards cho system health

#### 8.3.2. Security Enhancements

- Implement **rate limiting** cho API endpoints
- Add **CSRF protection** cho sensitive operations
- Setup **WAF** (Web Application Firewall)
- Regular **security audits** v√† penetration testing

#### 8.3.3. Performance Optimizations

- Implement **Redis** cho caching layer
- Add **database indexing** optimization
- Setup **CDN** cho static assets
- Implement **lazy loading** cho heavy components

#### 8.3.4. Scalability Considerations

- Consider **microservices** architecture khi c·∫ßn thi·∫øt
- Implement **horizontal scaling** cho database
- Add **load balancing** cho high traffic
- Setup **auto-scaling** infrastructure

## 9. K·∫øt lu·∫≠n

### 9.1. T√≥m t·∫Øt ƒë√°nh gi√°

ChatStoryAI l√† m·ªôt d·ª± √°n ƒë∆∞·ª£c thi·∫øt k·∫ø v√† ph√°t tri·ªÉn kh√° t·ªët v·ªõi ki·∫øn tr√∫c monorepo full-stack hi·ªán ƒë·∫°i. D·ª± √°n th·ªÉ hi·ªán s·ª± hi·ªÉu bi·∫øt s√¢u s·∫Øc v·ªÅ c√°c best practices trong ph√°t tri·ªÉn web, t·ª´ vi·ªác s·ª≠ d·ª•ng c√¥ng ngh·ªá ti√™n ti·∫øn nh∆∞ Next.js 15, React 19, TypeScript, ƒë·∫øn vi·ªác thi·∫øt k·∫ø database schema h·ª£p l√Ω v√† t√≠ch h·ª£p CI/CD pipeline ho√†n ch·ªânh.

**ƒêi·ªÉm n·ªïi b·∫≠t:**

- Ki·∫øn tr√∫c t·ªïng th·ªÉ r√µ r√†ng v√† c√≥ t·ªï ch·ª©c t·ªët
- T√≠ch h·ª£p AI m·ªôt c√°ch th√¥ng minh v√† hi·ªáu qu·∫£
- H·ªó tr·ª£ dual authentication (session + API key)
- Docker containerization ho√†n ch·ªânh
- CI/CD pipeline b√†i b·∫£n v·ªõi GitHub Actions

### 9.2. Roadmap ph√°t tri·ªÉn

**Phase 1 (Ng·∫Øn h·∫°n - 1-2 th√°ng):**

1. Implement automated testing suite
2. Chuy·ªÉn ƒë·ªïi file storage t·ª´ Google Drive sang Vercel Blob/S3
3. C·∫£i thi·ªán error handling v√† logging
4. Th√™m monitoring c∆° b·∫£n

**Phase 2 (Trung h·∫°n - 3-6 th√°ng):**

1. Implement global state management
2. Performance optimization v√† caching
3. Security enhancements
4. Mobile app development (n·∫øu c·∫ßn)

**Phase 3 (D√†i h·∫°n - 6-12 th√°ng):**

1. Microservices architecture (n·∫øu c·∫ßn thi·∫øt)
2. Advanced analytics v√† AI features
3. Scalability improvements
4. International expansion

### 9.3. Khuy·∫øn ngh·ªã cu·ªëi c√πng

ChatStoryAI c√≥ n·ªÅn t·∫£ng k·ªπ thu·∫≠t v·ªØng ch·∫Øc ƒë·ªÉ ph√°t tri·ªÉn th√†nh m·ªôt n·ªÅn t·∫£ng s√°ng t·∫°o truy·ªán h√†ng ƒë·∫ßu. V·ªõi vi·ªác th·ª±c hi·ªán c√°c c·∫£i ti·∫øn ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t, ƒë·∫∑c bi·ªát l√† testing strategy v√† file storage optimization, d·ª± √°n s·∫Ω c√≥ kh·∫£ nƒÉng scale v√† maintain t·ªët h∆°n trong t∆∞∆°ng lai.

ƒê·ªôi ng≈© ph√°t tri·ªÉn n√™n t·∫≠p trung v√†o vi·ªác x√¢y d·ª±ng test suite v√† c·∫£i thi·ªán developer experience tr∆∞·ªõc khi m·ªü r·ªông t√≠nh nƒÉng. ƒêi·ªÅu n√†y s·∫Ω ƒë·∫£m b·∫£o ch·∫•t l∆∞·ª£ng code v√† gi·∫£m thi·ªÉu r·ªßi ro khi ph√°t tri·ªÉn c√°c t√≠nh nƒÉng m·ªõi.

---

_T√†i li·ªáu n√†y s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªãnh k·ª≥ khi c√≥ thay ƒë·ªïi trong ki·∫øn tr√∫c h·ªá th·ªëng ho·∫∑c khi implement c√°c ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn._
