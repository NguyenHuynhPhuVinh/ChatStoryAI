# Story 1.5: Configuration và Environment Management

## Status

In Progress

## Story

**As a** developer,
**I want** flexible configuration options for database initialization behavior,
**so that** I can control the initialization process based on different environments và requirements.

## Acceptance Criteria

1. **AC1**: Environment variable để enable/disable auto-initialization (`DB_AUTO_INIT=true/false`)
2. **AC2**: Configuration cho initialization timeout settings
3. **AC3**: Option để skip specific migration scripts
4. **AC4**: Development vs production mode configurations
5. **AC5**: Logging level configuration cho initialization process
6. **AC6**: Fallback behavior configuration khi initialization fails

## Tasks / Subtasks

- [x] Task 1: Implement DB_AUTO_INIT environment variable control (AC: 1)

  - [x] Add DB_AUTO_INIT environment variable parsing in getStartupConfigFromEnv()
  - [x] Update StartupConfig interface to include autoInitEnabled flag
  - [x] Modify initializeApplication() to respect autoInitEnabled setting
  - [x] Add validation and default value handling for DB_AUTO_INIT
  - [x] Update .env.example with DB_AUTO_INIT documentation

- [x] Task 2: Enhance timeout configuration system (AC: 2)

  - [x] Add DB_INIT_TIMEOUT environment variable for overall initialization timeout
  - [x] Add DB_HEALTH_CHECK_RETRY_DELAY for health check retry intervals
  - [x] Add DB_MIGRATION_TIMEOUT for migration execution timeout
  - [x] Update StartupConfig interface with new timeout options
  - [x] Implement timeout validation and reasonable defaults

- [x] Task 3: Implement migration script skipping functionality (AC: 3)

  - [x] Add DB_MIGRATION_SKIP_SCRIPTS environment variable for comma-separated script names
  - [x] Add DB_MIGRATION_SKIP_PATTERN environment variable for regex pattern matching
  - [x] Update MigrationOptions interface in startup-init.ts
  - [x] Modify discoverMigrationScripts() to filter out skipped scripts
  - [x] Add logging for skipped scripts with reasons

- [ ] Task 4: Development vs Production mode configurations (AC: 4)

  - [ ] Add NODE_ENV-based configuration defaults
  - [ ] Implement DB_INIT_MODE environment variable (development/production/test)
  - [ ] Add production-safe defaults (stricter timeouts, minimal logging)
  - [ ] Add development-friendly defaults (verbose logging, longer timeouts)
  - [ ] Update configuration loading logic to apply mode-specific settings

- [ ] Task 5: Logging level configuration system (AC: 5)

  - [ ] Add DB_INIT_LOG_LEVEL environment variable (minimal/detailed/debug)
  - [ ] Update all logger functions to respect log level settings
  - [ ] Implement log level filtering in migrationLogger, creationLogger, detectionLogger
  - [ ] Add structured logging format configuration option
  - [ ] Update existing log statements to use appropriate log levels

- [ ] Task 6: Fallback behavior configuration (AC: 6)

  - [ ] Add DB_INIT_FALLBACK_BEHAVIOR environment variable (continue/exit/retry)
  - [ ] Add DB_INIT_MAX_RETRIES for retry-based fallback behavior
  - [ ] Add DB_INIT_RETRY_DELAY for retry interval configuration
  - [ ] Update GracefulFailureConfig interface with new options
  - [ ] Implement retry logic in initializeApplication()

- [ ] Task 7: Configuration validation and documentation

  - [ ] Create comprehensive configuration validation function
  - [ ] Add configuration conflict detection (e.g., conflicting timeout values)
  - [ ] Update .env.example with all new environment variables and descriptions
  - [ ] Add configuration summary logging on startup
  - [ ] Create configuration troubleshooting guide in comments

- [ ] Task 8: Unit testing for configuration system (Testing Requirements)
  - [ ] Test environment variable parsing with various combinations
  - [ ] Test configuration validation and error handling
  - [ ] Test mode-specific configuration loading
  - [ ] Test timeout and retry behavior
  - [ ] Test logging level filtering functionality
  - [ ] Achieve minimum 90% test coverage for configuration code

## Dev Notes

### Previous Story Insights

From Story 1.4 (SQL Migration Script Execution Engine):

- Migration system already has basic configuration through migrationOptions in StartupConfig
- Environment variables are parsed in getStartupConfigFromEnv() function
- Existing migration configuration includes skipFailedScripts, dryRun, and migrationDirectory options
- Logging system is already structured with JSON format in migrationLogger
- Integration point is through startup-init.ts module

### Current Configuration Architecture

[Source: src/lib/startup-init.ts]

**Existing StartupConfig Interface:**

- enableDatabaseHealthCheck: boolean
- enableDatabaseCreation: boolean
- enableMigrationExecution: boolean
- healthCheckTimeout: number (milliseconds)
- gracefulFailureConfig: Partial<GracefulFailureConfig>
- skipOnProduction?: boolean
- logLevel: "minimal" | "detailed"
- databaseCreationOptions?: object
- migrationOptions?: object

**Current Environment Variables:**

- DB_HEALTH_CHECK_ENABLED: Controls health check execution
- DB_AUTO_CREATE_ENABLED: Controls automatic database creation
- DB_MIGRATION_ENABLED: Controls migration execution
- DB_HEALTH_CHECK_TIMEOUT: Health check timeout in milliseconds
- DB_MIGRATION_SKIP_FAILED: Skip failed migration scripts
- DB_MIGRATION_DRY_RUN: Run migrations in dry-run mode
- DB_MIGRATION_DIRECTORY: Custom migration directory path

### Database Configuration Patterns

[Source: src/lib/db.ts]

**MySQL Connection Configuration:**

- Uses environment variables: MYSQL_HOST, MYSQL_PORT, MYSQL_USER, MYSQL_PASSWORD, MYSQL_DATABASE
- SSL configuration through MYSQL*SSL*\* environment variables
- Connection pooling with mysql2/promise library

### File Locations

[Source: Project Structure Analysis]

**Configuration Files:**

- Main configuration: `src/lib/startup-init.ts` (StartupConfig interface and getStartupConfigFromEnv function)
- Database connection: `src/lib/db.ts` (connection pool configuration)
- Environment template: `.env.example` (environment variable documentation)
- Docker configuration: `docker-compose.yml` (container environment variables)

**Testing Files:**

- Configuration tests: `src/lib/__tests__/startup-init.test.ts` (existing test patterns)
- Test setup: `jest.setup.js` (test environment variables)

### Technical Constraints

[Source: Architecture Analysis]

**TypeScript Requirements:**

- Strict typing enabled in tsconfig.json
- All configuration interfaces must be properly typed
- Environment variable parsing must handle string to appropriate type conversion

**Testing Requirements:**
[Source: jest.config.js]

- Minimum 90% test coverage required
- Tests must use jest-environment-node
- Mock environment variables in test setup
- Test timeout: 10 seconds maximum

**Logging Standards:**
[Source: Existing Logger Analysis]

- Structured JSON logging format
- Timestamp inclusion in all log entries
- Operation-specific log prefixes ([DB-MIGRATION], [DB-CREATION], etc.)
- Console.info for normal operations, console.error for errors

### Integration Points

[Source: src/lib/startup-init.ts]

**Configuration Loading Flow:**

1. getStartupConfigFromEnv() parses environment variables
2. Configuration merged with DEFAULT_STARTUP_CONFIG
3. initializeApplication() uses merged configuration
4. Individual modules (db-health, db-creation, db-migration) receive configuration

**Environment Variable Naming Convention:**

- DB\_\* prefix for database-related settings
- Specific module prefixes: DB*HEALTH_CHECK*_, DB*MIGRATION*_, DB*AUTO_CREATE*\*
- Boolean values: "true"/"false" strings
- Numeric values: string representation of numbers
- List values: comma-separated strings

### Testing

**Test File Location:** `src/lib/__tests__/startup-init.test.ts`

**Testing Framework:** Jest with Node.js environment

**Test Patterns:**

- Mock environment variables using process.env assignments
- Test configuration parsing with various environment variable combinations
- Test default value handling when environment variables are not set
- Test configuration validation and error scenarios
- Mock console methods to avoid test output noise

**Coverage Requirements:**

- Minimum 90% coverage for all configuration-related code
- Test all environment variable parsing paths
- Test configuration validation logic
- Test integration with existing startup initialization flow

**Test Organization:**

- Group tests by functionality (environment parsing, validation, integration)
- Use descriptive test names that explain the scenario being tested
- Include both positive and negative test cases
- Test edge cases like invalid values, missing variables, and conflicting settings

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-07-18 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Augment Agent)

### Debug Log References

- Task 1 started: 2025-07-18 - Implementing DB_AUTO_INIT environment variable control
- Task 1 completed: 2025-07-18 - All tests passing, DB_AUTO_INIT functionality working
- Task 2 started: 2025-07-18 - Implementing timeout configuration system
- Task 2 completed: 2025-07-18 - All timeout configurations implemented with validation and tests
- Task 3 started: 2025-07-18 - Implementing migration script skipping functionality
- Task 3 completed: 2025-07-18 - Migration script skipping implemented with comprehensive filtering and tests

### Completion Notes List

- Task 1: ✅ DB_AUTO_INIT environment variable successfully implemented with validation and tests
- Task 2: ✅ Timeout configuration system successfully implemented with comprehensive validation
- Task 3: ✅ Migration script skipping functionality successfully implemented with both name and pattern filtering

### File List

- src/lib/startup-init.ts - Updated StartupConfig interface, getStartupConfigFromEnv(), initializeApplication()
- src/lib/**tests**/startup-init.test.ts - Added comprehensive tests for DB_AUTO_INIT and migration skipping functionality
- src/lib/db-migration.ts - Added filterSkippedScripts function and updated runMigrations to support script skipping
- src/lib/**tests**/db-migration.test.ts - Added comprehensive tests for filterSkippedScripts function
- .env.example - Added DB_AUTO_INIT, timeout, and migration skipping documentation

### Change Log

- Added autoInitEnabled flag to StartupConfig interface
- Implemented DB_AUTO_INIT environment variable parsing with validation
- Added early exit logic in initializeApplication() when autoInitEnabled is false
- Added comprehensive test coverage for DB_AUTO_INIT functionality
- Added timeout configuration fields to StartupConfig interface (initTimeout, healthCheckRetryDelay, migrationTimeout)
- Implemented timeout environment variable parsing with validation (DB_INIT_TIMEOUT, DB_HEALTH_CHECK_RETRY_DELAY, DB_MIGRATION_TIMEOUT)
- Added overall initialization timeout wrapper with Promise.race pattern
- Added parseTimeout helper function with comprehensive validation and error handling
- Extended MigrationOptions interface with skipScripts and skipPattern fields
- Implemented DB_MIGRATION_SKIP_SCRIPTS and DB_MIGRATION_SKIP_PATTERN environment variable parsing
- Added filterSkippedScripts function with support for both explicit names and regex patterns
- Updated runMigrations function to filter scripts before execution
- Added comprehensive logging for skipped scripts with reasons
- Updated .env.example with complete configuration documentation

## QA Results

_This section will be populated by the QA agent after story completion_
